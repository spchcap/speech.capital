<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log In - speech.capital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/scrypt-js@3.0.1/scrypt.min.js"></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body class="bg-black text-white min-h-screen flex items-center justify-center font-mono">
  <div class="w-full max-w-xs" x-data="f()">
    <h1 class="text-xl text-yellow-200 mb-4">Log In</h1>
    <form @submit.prevent="s" class="space-y-4">
      <input x-model="u" type="text" placeholder="username" required class="bg-gray-900 border-yellow-200/30 rounded w-full p-2">
      <input x-model="p" type="password" placeholder="password" required class="bg-gray-900 border-yellow-200/30 rounded w-full p-2">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAAB4klN__r6wwJXs4"></div>
      <button type="submit" :disabled="l" class="bg-yellow-200/80 hover:bg-yellow-200 text-black w-full p-2 rounded" x-text="l?'...':'Log In'"></button>
    </form>
    <p x-show="e" x-text="e" class="text-red-400 text-xs mt-2"></p>
    <p class="text-xs mt-4">No account? <a href="/signup" class="text-yellow-200/80 hover:text-yellow-200">Sign up</a>.</p>
  </div>
<script>
f=()=>({u:'',p:'',e:null,l:false,async s(){this.l=!0;this.e=null;try{const token=this.$el.querySelector('[name="cf-turnstile-response"]')?.value;if(!token)throw new Error('Please complete the CAPTCHA.');const r1=await fetch(`/api/auth-params?username=${this.u}`);if(!r1.ok)throw new Error('User not found.');const{N,r,p,salt_b64}=await r1.json();const pw=(new TextEncoder()).encode(this.p),dec=s=>Uint8Array.from(atob(s),c=>c.charCodeAt(0)),salt=dec(salt_b64);const h=await scrypt.scrypt(pw,salt,N,r,p,32),b64=a=>btoa(String.fromCharCode(...a));const h_str=`scrypt$${N}$${r}$${p}$${salt_b64}$${b64(h)}`;const r2=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:this.u,pass_hash:h_str,'cf-turnstile-response':token})});if(!r2.ok){const d=await r2.json();throw new Error(d.error?.message||'Login failed')}window.location.href='/'}catch(e){this.e=e.message}finally{this.l=!1}}})
</script>
</body>
</html>
